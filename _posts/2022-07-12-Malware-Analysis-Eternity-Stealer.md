---
title:  "Malware Analysis: Eternity Stealer"
header:
categories:
  - Reverse Engineering
classes: wide
tags:
  - reverseengineering malwareanalysis
---
 Hey guys! Welcome to the first malware analysis post on this blog! Hope you have as much fun as I did while analysing this sample!
 
 In this post, we will be having a look at the Eternity Stealer, by the Eternity group.
 
 
## Summary ##
### Objective ###
 The objective of this post is to give a clear understanding of the workings of the Eternity Stealer, and explain, to a basic extent, the workings and methods used by said Stealer.
 
### The Eternity Stealer  ###
This Stealer is written in C#, and is capable of stealing data from various well-known applications. This stolen data can either be used on its own in order to compromise user accounts, or can be used in coordination with other exploits. The key impact caused by this Stealer is seen in the huge amounts of user data stolen from users who are infected.

## Basic Static Analysis ##
A quick strings and PE analysis on the sample drops a couple of hints. For example, we can see strings such as mscoree.dll and strings which contain the word Stealer in them. PE analysis shows us that the signature on the executable is .NET which tells us that this is most likely a Stealer written in C#. Further analysis will confirm this.
 
- PEStudio:
	```
	signature: Microsoft .NET
	```
 
- Strings:
	```
	System.Collections.Generic.IEnumerator<Stealer.Utils.Models.CreditCard>.Current
	System.Collections.Generic.IEnumerator<System.Text.Json.JSONNode>.Current
	System.Collections.Generic.IEnumerator<Stealer.Utils.Models.Cookie>.Current
	System.Collections.Generic.IEnumerator<Stealer.Recovery.Browsers.Chrome.ChromeProfile>.Current
	System.Collections.Generic.IEnumerator<Stealer.Recovery.Browsers.Firefox.FirefoxProfile>.Current
	```

Further analysis shows us that most of the function names are obfuscated. Taking a look at the Main function, there is further obfuscation and noise as expected, however, two functions that catch our attention are the SSD and DS functions, which seem to be widely used throughout the code.

- Part of code from  ``` Main()```: 
  ```csharp
public static void Main(string[] args)
{
	byggwqoelmbooxkolucfphxyxbruffw.PerformMutexCheck(
		byggwqoelmbooxkolucfphxyxbruffw.SSD(byggwqoelmbooxkolucfphxyxbruff
		.DS(byggwqoelmbooxkolucfphxyxbruffw.
			qtlqsgxmmxrwelwudgrvdahudbiomtyejhh()), 4L));
	
	byggwqoelmbooxkolucfphxyxbruffw.PerformSelfDestruct();
	byte[] array = null;
	try
	{
   ```

- Format of ```SSD``` and ```DS``` functions:
   ```csharp
   classA.funcFunction(classA.SSD(classA.DS(classA.obfuscatedstringA(), 	       classA.obfuscatedstringB()), xL));
	```

#### Obfuscation ####
Upon inspecting the SSD and DS functions, we can see that these functions are obfuscation methods. Obfuscation techniques are used to slow the analysis process down. The function SSD will take AES encrypted arguments from the DS function and further encode it. The strings that are obfuscated are encoded in Base64.

- ```SSD()``` function:
  ```csharp
public static string SSD(string A_0, long A_1)        
{            
   char[] array = A_0.ToCharArray();            
   for (int i = -20727 + 20727; i < array.Length; i += -50515 + 50516)            
	
   {                
	  int num = Convert.ToInt32(array[i]);                
	  int num2 = Convert.ToInt32(A_1);                
	  if (num + num2 < -67057 + 67313 && num - num2 > -59779 + 59779)           
	  {                    	  
		  array[i] = Convert.ToChar(num - num2);                                   
	  }                
       array[i] = (char.IsUpper(array[i]) ? char.ToLower(array[i]) : 
					char.ToUpper(array[i]));
	   
    }            
    Array.Reverse(array);            
    return string.Join<char>(string.Empty, array);
}
   ```