---
title:  "Windows Malware Development Part 1: PE File Format"
header:
  teaser: "/assets/images/pe.png"
  teaser_home_page: true
categories:
  - Malware Dev
classes: wide
tags:
  - Malware Dev
---

## Objective ##

Hey guys! Welcome to the first post in a series of posts aimed at learning Windows malware development! In this post, we will be looking at the PE file format, which is an important step in learning how to make a Windows executable.

## What is a PE? ##
A Portable Executable (PE) is a file format for executable files that can be understood and run by the Windows OS. The PE format is one of the file formats that are known as  Common Object File Format (COFF) files.

This format does not only apply for `.exe` files, but is also used for Dynamic Link Libraries (`.dll`), driver configuration files (`.sys`),  Screen Saver files (`.scr`), and more.

The PE file format is a very important part of the Windows OS, since it contains necessary information required in order for the OS to load an executable in to memory and execute it.

## The PE Format ##

This diagram is a short overview of what the PE file structure looks like. Let's go over each part in detail in order to understand this better.
 
 ![PE Diagram](/assets/images/pe.png)

### The DOS Header ###
The first 64 bytes of a PE file are occupied by the DOS header. This header is used in order to identify whether the file is a valid MS DOS executable or not. The structure of the DOS header is as follows:

```cpp
typedef struct _IMAGE_DOS_HEADER {      // DOS .EXE header
    WORD   e_magic;                     // Magic number
    WORD   e_cblp;                      // Bytes on last page of file
    WORD   e_cp;                        // Pages in file
    WORD   e_crlc;                      // Relocations
    WORD   e_cparhdr;                   // Size of header in paragraphs
    WORD   e_minalloc;                  // Minimum extra paragraphs needed
    WORD   e_maxalloc;                  // Maximum extra paragraphs needed
    WORD   e_ss;                        // Initial (relative) SS value
    WORD   e_sp;                        // Initial SP value
    WORD   e_csum;                      // Checksum
    WORD   e_ip;                        // Initial IP value
    WORD   e_cs;                        // Initial (relative) CS value
    WORD   e_lfarlc;                    // File address of relocation table
    WORD   e_ovno;                      // Overlay number
    WORD   e_res[4];                    // Reserved words
    WORD   e_oemid;                     // OEM identifier (for e_oeminfo)
    WORD   e_oeminfo;                   // OEM information; e_oemid specific
    WORD   e_res2[10];                  // Reserved words
    LONG   e_lfanew;                    // File address of new exe header
  } IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;
```

Out of all these values, two are of interest to us:
- `e_magic`: This `WORD` is also called the magic number, and has a fixed value of `0x4D 0x5A` (MZ) in Windows executables. This is a signature used in order to identify a MS-DOS executable.
- `e_lfanew`: This member holds an offset to the beginning of the NT Headers.

### The DOS Stub ###
This is a program that prints the error "This program cannot be run in DOS mode." in case the executable is loaded in DOS Mode. It should be noted that this message can be changed by the developer during compilation.
```
0E 1F BA 0E 00 B4 09 CD 21 B8 01 4C CD 21 54 68 69 73 20 70 72 6F 67 72 61 6D 20 63 61 6E 6E 6F 74 20 62 65 20 72 75 6E 20 69 6E 20 44 4F 53 20 6D 6F 64 65 2E 0D 0D 0A 24 00  00 00 00 00 00 00 
```

 ![DOS Stub](/assets/images/DOS_stub.png)

### NT Headers ###
The structure NT headers is defined in `winnt.h` as `IMAGE_NT_HEADERS`, and contains important information about the PE file. It should be noted, that the structure is defined differently for 32 bit and 64 bit. 

32 bit:
```cpp
typedef struct _IMAGE_NT_HEADERS { 
DWORD                     Signature; 
IMAGE_FILE_HEADER         FileHeader; 
IMAGE_OPTIONAL_HEADER32   OptionalHeader; 
} IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;
```

64 bit:
```cpp
typedef struct _IMAGE_NT_HEADERS { 
DWORD                     Signature; 
IMAGE_FILE_HEADER         FileHeader; 
IMAGE_OPTIONAL_HEADER64   OptionalHeader; 
} IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS64;
```

#### Signature ####
The `DWORD` member `Signature` is used to identify a PE file, and has a fixed value of `0x50450000` which translates to `PE\0\0`.

![Signature](/assets/images/signature.png)

#### File Header ####
The `FileHeader` member is a structure of type `IMAGE_FILE_HEADER`, and is also known as the COFF header. The structure is defined as follows:

```cpp
typedef struct _IMAGE_FILE_HEADER {
    WORD    Machine;
    WORD    NumberOfSections;
    DWORD   TimeDateStamp;
    DWORD   PointerToSymbolTable;
    DWORD   NumberOfSymbols;
    WORD    SizeOfOptionalHeader;
    WORD    Characteristics;
} IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;
```

Out of all the members, three are of interest to us:
- `NumberOfSections`: 