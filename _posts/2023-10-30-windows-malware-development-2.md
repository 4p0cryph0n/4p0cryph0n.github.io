---
title: "Windows Malware Development Part 2: Payload Placement Basics - .text"
header:
  teaser: /assets/images/pe.png
  teaser_home_page: true
categories:
  - Malware Dev
classes: wide
tags:
  - Malware
toc: true
toc_label: Contents
---
## Objective ##

Hey guys, welcome to the second part of Windows Malware Development, where we will be beginning with the basics of payload placement. In this post, we will be looking at how to place our shellcode in the `.text` section.

## .text Section ##

If you recall from the previous post, the `.text` section contains code that needs to be executed by the program. For example, any code that lies within the `main` function of your program goes in the `.text` section.

In this example, we will be looking at a basic program that:
- Stores shellcode in a memory buffer.
- Makes that buffer executable in nature.
- Executes the shellcode.

> **_NOTE:_**  You will need Visual Studio/Visual studio build tools and x64dbg for this exercise.

## Writing the program ##

### Defining Shellcode Array ###

We will first start off buy defining a character array that initially holds our shellcode:
```cpp
#include <windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int main(void) {
    
	void * exec_mem;
	BOOL vp;
	HANDLE th;
    DWORD initialprotect = 0;

	unsigned char payload[] = {
		0x90,		
		0x90,		
		0xcc,		
		0xc3		
	};
```

The shellcode here in question is a series of assembly instruction that goes as follows:
- `0x90`: No operation (NOP)
- `0x90`: No operation (NOP)
- `0xcc`: Break
- `0xc3`: Return (RET)

This is essentially a test shellcode, and its only function is to break the execution flow of our program. Why I'm using this particular shellcode is because we will be inspecting this program in the debugger later, and the `0xcc` instruction will help us with that.

### Allocating a Memory Buffer ###

Now, let's allocate a memory buffer for storing our shellcode. We will be using the Windows API `VirtualAlloc` for this. Taking a look at documentation for `VirtualAlloc`, we can see that it takes 4 parameters:

```cpp
LPVOID VirtualAlloc(
  [in, optional] LPVOID lpAddress,
  [in]           SIZE_T dwSize,
  [in]           DWORD  flAllocationType,
  [in]           DWORD  flProtect
);
```









